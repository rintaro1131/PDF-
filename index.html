<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' blob:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' blob:; connect-src 'none'; frame-ancestors 'none'; base-uri 'none'; object-src 'none';">
    <title>文書結合ツール（PDF・Excel・Word対応）</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        .drop-zone.dragover {
            border-color: #007bff;
            background-color: #f0f8ff;
        }
        .file-input {
            margin-bottom: 20px;
        }
        .file-input-hidden {
            position: absolute;
            left: -9999px;
            opacity: 0;
            pointer-events: none;
        }
        .file-select-label {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .file-select-label:hover {
            background: #0056b3;
        }
        .file-list {
            margin: 20px 0;
        }
        .file-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: 5px;
            border-radius: 4px;
            background: #fafafa;
        }
        .file-info {
            flex: 1;
            margin-left: 10px;
        }
        .file-controls {
            display: flex;
            gap: 5px;
        }
        .btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-up { background: #28a745; color: white; }
        .btn-down { background: #17a2b8; color: white; }
        .btn-remove { background: #dc3545; color: white; }
        .btn-primary {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            font-size: 16px;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .filename-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background: #e9ecef;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .execute-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>文書結合ツール</h1>
        
        <div class="drop-zone" id="dropZone">
            <p>PDF・Excel・Wordファイルをここにドラッグ&ドロップするか、下のボタンで選択してください</p>
        </div>
        
        <div class="file-input">
            <input type="file" id="fileInput" multiple accept=".pdf,.xlsx,.xls,.docx,.doc" style="display: block; margin: 10px 0;">
            <button type="button" id="fileSelectBtn" class="btn btn-primary">ファイルを選択</button>
            <label for="fileInput" class="file-select-label" style="margin-left: 10px;">または、ここをクリック</label>
        </div>
        
        <div class="status" id="status">PDF・Excel・Wordファイルを選択してください</div>
        <div id="debugInfo" style="display: none; background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; border: 1px solid #dee2e6;"></div>
        
        <div class="file-list">
            <h3>選択されたファイル</h3>
            <div id="fileList"></div>
        </div>
        
        <div class="execute-section">
            <label for="filename">結合後のファイル名:</label>
            <input type="text" id="filename" class="filename-input" placeholder="ファイル名を入力" list="filename-suggestions">
            <datalist id="filename-suggestions">
                <option value="20250月_名前_出勤簿">
                <option value="20250月_名前_身嗜手当">
                <option value="20250月_名前_社販手当">
                <option value="20250月_名前_報奨金">
                <option value="20250月__名前_立替金">
            </datalist>
            
            <button id="mergeBtn" class="btn btn-primary" disabled onclick="mergePDFs()">PDF結合実行</button>
        </div>
        
        <div class="warning">
            <strong>注意:</strong> 
            <ul style="margin: 5px 0; padding-left: 20px;">
                <li>Excel・Wordファイルは簡易的にPDFに変換されます（レイアウトは基本的なもの）</li>
                <li>複雑な書式・図表・マクロ等は正しく変換されない場合があります</li>
                <li>巨大ファイルや多数のファイルを結合する場合、メモリ制約により処理に時間がかかります</li>
            </ul>
        </div>
    </div>

    <script src="./lib/pdf-lib.min.js"></script>
    <script src="./lib/xlsx.mini.min.js"></script>
    <script>
        let documentFiles = [];
        let unsupportedCount = 0;

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileSelectBtn = document.getElementById('fileSelectBtn');
        const fileList = document.getElementById('fileList');
        const status = document.getElementById('status');
        const mergeBtn = document.getElementById('mergeBtn');
        const filenameInput = document.getElementById('filename');
        const debugInfo = document.getElementById('debugInfo');
        
        // デバッグモード（URLパラメータで有効化）
        const isDebugMode = new URLSearchParams(window.location.search).has('debug');
        if (isDebugMode) {
            debugInfo.style.display = 'block';
            debugLog('Debug mode enabled');
        }
        
        function debugLog(message) {
            if (isDebugMode) {
                console.log(message);
                const timestamp = new Date().toLocaleTimeString();
                debugInfo.innerHTML += `[${timestamp}] ${message}<br>`;
                debugInfo.scrollTop = debugInfo.scrollHeight;
            }
        }
        
        // ライブラリの読み込み確認
        window.addEventListener('load', () => {
            debugLog('Window loaded');
            debugLog(`PDFLib available: ${typeof PDFLib !== 'undefined'}`);
            debugLog(`XLSX available: ${typeof XLSX !== 'undefined'}`);
            
            if (typeof PDFLib !== 'undefined') {
                debugLog(`PDFLib.PDFDocument: ${typeof PDFLib.PDFDocument}`);
            }
            if (typeof XLSX !== 'undefined') {
                debugLog(`XLSX.read: ${typeof XLSX.read}`);
                debugLog(`XLSX.utils: ${typeof XLSX.utils}`);
            }
        });

        // ドキュメント全体でのドラッグ&ドロップ防止（ブラウザでファイルが開かないように）
        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
        });
        
        document.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
        });
        
        document.addEventListener('dragenter', (e) => {
            e.preventDefault();
            e.stopPropagation();
        });
        
        document.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
        });

        // ドロップゾーン専用のドラッグ&ドロップイベント
        dropZone.addEventListener('dragenter', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('dragover');
            debugLog('Drag enter detected');
        });
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            // ドロップゾーンから完全に出た場合のみクラスを削除
            if (!dropZone.contains(e.relatedTarget)) {
                dropZone.classList.remove('dragover');
                debugLog('Drag leave detected');
            }
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('dragover');
            debugLog(`Drop detected, files: ${e.dataTransfer.files.length}`);
            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                handleFiles(e.dataTransfer.files);
            } else {
                debugLog('ERROR: No files in drop event');
                status.textContent = 'ファイルの読み込みに失敗しました。再度お試しください。';
            }
        });

        // ファイル選択ボタンイベント
        fileSelectBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            debugLog('File select button clicked');
            
            try {
                // ファイル入力をリセット（同じファイルを再選択できるように）
                fileInput.value = '';
                fileInput.click();
                debugLog('File input clicked successfully');
            } catch (error) {
                debugLog(`ERROR: File input click failed: ${error.message}`);
                status.textContent = 'ファイル選択に失敗しました。ブラウザを再起動してください。';
            }
        });
        
        // ファイル選択イベント
        fileInput.addEventListener('change', (e) => {
            debugLog(`File input changed, files: ${e.target.files.length}`);
            if (e.target.files && e.target.files.length > 0) {
                handleFiles(e.target.files);
            } else {
                debugLog('WARNING: No files selected');
            }
        });

        function handleFiles(files) {
            debugLog(`handleFiles called with ${files.length} files`);
            
            if (!files || files.length === 0) {
                debugLog('WARNING: No files provided to handleFiles');
                return;
            }
            
            unsupportedCount = 0;
            const newDocumentFiles = [];
            
            // FileListをArrayに変換してループ
            const fileArray = Array.from(files);
            debugLog(`Processing files: ${fileArray.map(f => f.name).join(', ')}`);
            
            for (let file of fileArray) {
                const fileName = file.name.toLowerCase();
                debugLog(`Processing file: ${fileName}, type: ${file.type}`);
                
                if (file.type === 'application/pdf' || fileName.endsWith('.pdf') ||
                    fileName.endsWith('.xlsx') || fileName.endsWith('.xls') ||
                    fileName.endsWith('.docx') || fileName.endsWith('.doc') ||
                    file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                    file.type === 'application/vnd.ms-excel' ||
                    file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' ||
                    file.type === 'application/msword') {
                    newDocumentFiles.push(file);
                    debugLog(`Added file: ${fileName}`);
                } else {
                    unsupportedCount++;
                    debugLog(`Unsupported file: ${fileName}, type: ${file.type}`);
                }
            }
            
            documentFiles = [...documentFiles, ...newDocumentFiles];
            debugLog(`Total files now: ${documentFiles.length}`);
            
            updateStatus();
            updateFileList();
            updateMergeButton();
        }

        function updateStatus() {
            let statusText = `ファイル: ${documentFiles.length}件`;
            if (unsupportedCount > 0) {
                statusText += ` (対応外ファイル ${unsupportedCount}件は無視されました)`;
            }
            status.textContent = statusText;
        }

        function updateFileList() {
            fileList.innerHTML = '';
            documentFiles.forEach((file, index) => {
                const fileType = getFileType(file.name);
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <span class="file-info">
                        <strong>${file.name}</strong> (${formatFileSize(file.size)}) [${fileType}]
                    </span>
                    <div class="file-controls">
                        <button class="btn btn-up" onclick="moveFile(${index}, -1)" ${index === 0 ? 'disabled' : ''}>▲</button>
                        <button class="btn btn-down" onclick="moveFile(${index}, 1)" ${index === documentFiles.length - 1 ? 'disabled' : ''}>▼</button>
                        <button class="btn btn-remove" onclick="removeFile(${index})">×</button>
                    </div>
                `;
                fileList.appendChild(item);
            });
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function getFileType(fileName) {
            const ext = fileName.toLowerCase().split('.').pop();
            switch(ext) {
                case 'pdf': return 'PDF';
                case 'xlsx': case 'xls': return 'Excel';
                case 'docx': case 'doc': return 'Word';
                default: return '不明';
            }
        }

        function moveFile(index, direction) {
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < documentFiles.length) {
                [documentFiles[index], documentFiles[newIndex]] = [documentFiles[newIndex], documentFiles[index]];
                updateFileList();
            }
        }

        function removeFile(index) {
            documentFiles.splice(index, 1);
            updateStatus();
            updateFileList();
            updateMergeButton();
        }

        function updateMergeButton() {
            mergeBtn.disabled = documentFiles.length === 0;
        }

        function sanitizeFilename(filename) {
            return filename.replace(/[<>:"/\\|?*]/g, '_');
        }
        
        // 日本語文字を安全にPDFに描画するためのヘルパー関数
        function sanitizeTextForPdf(text) {
            debugLog(`Sanitizing text: ${text.substring(0, 30)}...`);
            
            // まずはローマ字に変換を試行
            let result = text
                // 一般的な日本語単語の置換
                .replace(/申請書/g, 'shinseisho')
                .replace(/手当/g, 'teate')
                .replace(/身嗜み/g, 'midashinami')
                .replace(/出勤簿/g, 'shukkinbo')
                .replace(/報奨金/g, 'hoshokin')
                .replace(/立替金/g, 'tatekaekin')
                .replace(/社販/g, 'shahan')
                // 一般的なひらがな
                .replace(/です/g, 'desu')
                .replace(/ます/g, 'masu')
                .replace(/ファイル/g, 'file')
                .replace(/フォルダ/g, 'folder')
                .replace(/サイズ/g, 'size')
                .replace(/タイプ/g, 'type')
                // 残りの文字を安全な文字に置換
                .replace(/[あ-ん]/g, (match) => `[hiragana]`) // ひらがな
                .replace(/[ア-ン]/g, (match) => `[katakana]`) // カタカナ
                .replace(/[一-龯]/g, (match) => `[kanji]`) // 漢字
                .replace(/[^\x00-\xFF]/g, '?'); // その他の非ASCII文字
                
            debugLog(`Sanitized result: ${result.substring(0, 30)}...`);
            return result;
        }
        
        // PDF-libで安全にテキストを描画する関数
        async function drawTextSafely(page, text, options) {
            try {
                // まず元のテキストで試行
                page.drawText(text, options);
                debugLog(`Text drawn successfully: ${text.substring(0, 20)}...`);
            } catch (error) {
                if (error.message.includes('WinAnsi cannot encode')) {
                    debugLog(`WinAnsi encoding error, using fallback for: ${text.substring(0, 20)}...`);
                    // フォールバック: 安全な文字に置換
                    const safeText = sanitizeTextForPdf(text);
                    page.drawText(safeText, options);
                    debugLog(`Fallback text drawn: ${safeText.substring(0, 20)}...`);
                } else {
                    throw error; // その他のエラーは再スロー
                }
            }
        }

        async function convertExcelToPdf(file) {
            debugLog(`Starting Excel conversion for: ${file.name}`);
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                debugLog(`Excel file loaded, size: ${arrayBuffer.byteLength} bytes`);
                
                const workbook = XLSX.read(arrayBuffer);
                debugLog(`Excel workbook parsed, sheets: ${workbook.SheetNames.length}`);
                
                if (workbook.SheetNames.length === 0) {
                    throw new Error('Excelファイルにシートが見つかりません');
                }
                
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                debugLog(`Processing sheet: ${firstSheetName}`);
                
                const pdfDoc = await PDFLib.PDFDocument.create();
                const page = pdfDoc.addPage([595.28, 841.89]); // A4サイズ
                const { width, height } = page.getSize();
                
                // 簡易的なテキスト抽出（CSV形式で処理）
                const csvData = XLSX.utils.sheet_to_csv(worksheet);
                const lines = csvData.split('\n').filter(line => line.trim());
                debugLog(`Excel data extracted, ${lines.length} lines`);
                
                let yPosition = height - 50;
                const lineHeight = 20;
                
                // ヘッダー情報を追加
                await drawTextSafely(page, `Excel file: ${file.name}`, {
                    x: 50,
                    y: yPosition,
                    size: 12
                });
                yPosition -= 30;
                
                await drawTextSafely(page, `Sheet: ${firstSheetName}`, {
                    x: 50,
                    y: yPosition,
                    size: 10
                });
                yPosition -= 30;
                
                for (const line of lines.slice(0, 30)) { // 最大30行まで
                    if (yPosition < 50) break;
                    const displayLine = line.substring(0, 80); // 最大80文字まで
                    if (displayLine.trim()) {
                        await drawTextSafely(page, displayLine, {
                            x: 50,
                            y: yPosition,
                            size: 8
                        });
                    }
                    yPosition -= lineHeight;
                }
                
                debugLog('Excel to PDF conversion completed');
                return await pdfDoc.save();
                
            } catch (error) {
                debugLog(`ERROR in Excel conversion: ${error.message}`);
                throw new Error(`Excelファイルの変換に失敗しました: ${error.message}`);
            }
        }

        async function convertWordToPdf(file) {
            debugLog(`Starting Word conversion for: ${file.name}`);
            
            try {
                const pdfDoc = await PDFLib.PDFDocument.create();
                const page = pdfDoc.addPage([595.28, 841.89]);
                const { width, height } = page.getSize();
                
                // Word文書の場合は簡易的なファイル情報のみ表示（日本語を英語に変更）
                const info = [
                    `Filename: ${file.name}`,
                    `Size: ${formatFileSize(file.size)}`,
                    `Type: Word Document`,
                    `Last Modified: ${new Date(file.lastModified).toLocaleString()}`,
                    '',
                    '* This document was converted in simplified mode.',
                    'Please open the original file for accurate content.',
                    '',
                    'For complete Word to PDF conversion with Japanese text,',
                    'commercial libraries (Nutrient, Apryse, etc.) are required.'
                ];
                
                let yPosition = height - 100;
                const lineHeight = 30;
                
                for (const line of info) {
                    await drawTextSafely(page, line, {
                        x: 50,
                        y: yPosition,
                        size: 12
                    });
                    yPosition -= lineHeight;
                }
                
                debugLog('Word to PDF conversion completed');
                return await pdfDoc.save();
                
            } catch (error) {
                debugLog(`ERROR in Word conversion: ${error.message}`);
                throw new Error(`Wordファイルの変換に失敗しました: ${error.message}`);
            }
        }

        async function mergePDFs() {
            if (documentFiles.length === 0) {
                debugLog('ERROR: No files to merge');
                return;
            }

            debugLog(`Starting merge process with ${documentFiles.length} files`);

            try {
                mergeBtn.disabled = true;
                mergeBtn.textContent = '変換・結合中...';
                status.textContent = 'ファイルを処理しています...';

                // ライブラリの可用性を再確認
                if (typeof PDFLib === 'undefined') {
                    throw new Error('PDFLib is not loaded');
                }
                if (typeof XLSX === 'undefined') {
                    throw new Error('XLSX is not loaded');
                }

                debugLog('Creating merged PDF document');
                const mergedPdf = await PDFLib.PDFDocument.create();

                for (let i = 0; i < documentFiles.length; i++) {
                    const file = documentFiles[i];
                    const fileName = file.name.toLowerCase();
                    debugLog(`Processing file ${i + 1}/${documentFiles.length}: ${file.name}`);
                    status.textContent = `ファイルを処理しています... (${i + 1}/${documentFiles.length})`;
                    
                    let pdfBytes;
                    
                    try {
                        if (fileName.endsWith('.pdf')) {
                            debugLog(`Loading PDF file: ${file.name}`);
                            pdfBytes = await file.arrayBuffer();
                            debugLog(`PDF arrayBuffer size: ${pdfBytes.byteLength} bytes`);
                        } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                            debugLog(`Converting Excel file: ${file.name}`);
                            pdfBytes = await convertExcelToPdf(file);
                            debugLog(`Excel converted to PDF, size: ${pdfBytes.byteLength} bytes`);
                        } else if (fileName.endsWith('.docx') || fileName.endsWith('.doc')) {
                            debugLog(`Converting Word file: ${file.name}`);
                            pdfBytes = await convertWordToPdf(file);
                            debugLog(`Word converted to PDF, size: ${pdfBytes.byteLength} bytes`);
                        } else {
                            debugLog(`Skipping unsupported file: ${file.name}`);
                            continue; // 対応外ファイルはスキップ
                        }
                        
                        debugLog(`Loading PDF document from bytes`);
                        const pdf = await PDFLib.PDFDocument.load(pdfBytes);
                        const pageCount = pdf.getPageCount();
                        debugLog(`PDF loaded successfully, pages: ${pageCount}`);
                        
                        const pageIndices = Array.from({length: pageCount}, (_, i) => i);
                        debugLog(`Copying ${pageCount} pages`);
                        const copiedPages = await mergedPdf.copyPages(pdf, pageIndices);
                        
                        copiedPages.forEach((page) => mergedPdf.addPage(page));
                        debugLog(`Pages added to merged document`);
                        
                    } catch (fileError) {
                        debugLog(`ERROR processing file ${file.name}: ${fileError.message}`);
                        console.error(`Error processing file ${file.name}:`, fileError);
                        
                        // ファイル固有のエラー処理
                        if (fileError.message.includes('Invalid PDF')) {
                            throw new Error(`ファイル "${file.name}" は有効なPDFではありません。`);
                        } else if (fileError.message.includes('encrypted')) {
                            throw new Error(`ファイル "${file.name}" は暗号化されています。`);
                        } else {
                            throw new Error(`ファイル "${file.name}" の処理中にエラーが発生しました: ${fileError.message}`);
                        }
                    }
                }

                debugLog('Saving merged PDF');
                const mergedPdfBytes = await mergedPdf.save();
                debugLog(`Merged PDF saved, size: ${mergedPdfBytes.byteLength} bytes`);
                
                let filename = filenameInput.value.trim();
                if (!filename) {
                    filename = 'merged_documents';
                }
                filename = sanitizeFilename(filename);
                if (!filename.toLowerCase().endsWith('.pdf')) {
                    filename += '.pdf';
                }

                debugLog(`Creating download for: ${filename}`);
                const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                status.textContent = `結合完了: ${filename} をダウンロードしました`;
                debugLog('Merge process completed successfully');
                
            } catch (error) {
                debugLog(`CRITICAL ERROR: ${error.message}`);
                console.error('文書結合エラー:', error);
                
                // より詳細なエラーメッセージ
                let errorMessage = '文書結合に失敗しました。';
                if (error.message.includes('PDFLib is not loaded')) {
                    errorMessage += ' PDFライブラリが読み込まれていません。ページを再読み込みしてください。';
                } else if (error.message.includes('XLSX is not loaded')) {
                    errorMessage += ' Excelライブラリが読み込まれていません。ページを再読み込みしてください。';
                } else if (error.message.includes('暗号化')) {
                    errorMessage = error.message;
                } else if (error.message.includes('有効なPDF')) {
                    errorMessage = error.message;
                } else if (error.message.includes('の処理中に')) {
                    errorMessage = error.message;
                } else {
                    errorMessage += ` エラー詳細: ${error.message}`;
                }
                
                alert(errorMessage);
                status.textContent = '文書結合に失敗しました';
            } finally {
                mergeBtn.disabled = false;
                mergeBtn.textContent = 'PDF結合実行';
                updateMergeButton();
                debugLog('Merge process finished');
            }
        }
    </script>
</body>
</html>